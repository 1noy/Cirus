import{r as e}from"./vendor-Be9Gvr8Z.js";import{j as s,u as a,p as i}from"./index-DnPK_A-W.js";import{A as t,m as n}from"./ui-CVUBDUKm.js";import{a as l,u as c}from"./router-WS_FqKV8.js";import"./query-BCFsIYE1.js";import"./virtual-BJqExeNh.js";import"./utils-CkSu2hCt.js";import"./error-BaU7SGNY.js";import"./toast-DAwFn72h.js";import"./state-CH3XQ_Yu.js";import"./firebase-DLJYeIMi.js";const r=({visible:e,onClose:a,chats:i,contacts:l,currentUserId:c,onSelectChat:r,messages:o,pinned:d=!1})=>{const m=s.jsxs(s.Fragment,{children:[s.jsxs("div",{className:"drawer__header",children:[s.jsx("h3",{children:"Conversations"}),!d&&s.jsx("button",{className:"btn btn-icon",onClick:a,"aria-label":"Fermer",children:s.jsx("i",{className:"fas fa-times"})})]}),s.jsx("div",{className:"chat-list",children:(null==i?void 0:i.length)?i.map(e=>{var a,i;const t=(e=>{var s;return null==(s=null==e?void 0:e.participants)?void 0:s.find(e=>e!==c)})(e),n=(d=t,null==l?void 0:l.find(e=>e.uid===d));var d;const m=(u=e.id,((null==o?void 0:o[u])||[]).filter(e=>!e.read&&e.senderId!==c).length);var u;return s.jsxs("button",{className:"chat-item",onClick:()=>r(e.id),children:[s.jsx("div",{className:"chat-item__avatar",children:(null==n?void 0:n.photoURL)?s.jsx("img",{src:n.photoURL,alt:n.displayName||"Utilisateur"}):s.jsx("i",{className:"fas fa-user"})}),s.jsxs("div",{className:"chat-item__info",children:[s.jsxs("div",{className:"chat-item__name",children:[(null==n?void 0:n.displayName)||"Utilisateur",(null==n?void 0:n.online)&&s.jsx("span",{style:{marginLeft:8,width:8,height:8,borderRadius:999,background:"var(--accent)",display:"inline-block",boxShadow:"0 0 8px var(--accent)"}})]}),s.jsx("div",{className:"chat-item__meta",children:(null==(i=null==(a=null==e?void 0:e.lastMessage)?void 0:a.content)?void 0:i.slice(0,40))||"Nouvelle conversation"})]}),m>0&&s.jsx("span",{className:"badge-unread","aria-label":`${m} non lus`,children:m}),s.jsx("i",{className:"fas fa-chevron-right chat-item__chev"})]},e.id)}):s.jsx("div",{className:"empty-messages",style:{padding:16},children:"Aucune conversation"})})]});return d?s.jsx("div",{className:"drawer drawer--pinned",children:m}):s.jsx(t,{children:e&&s.jsx(n.aside,{className:"drawer",initial:{x:-320,opacity:0},animate:{x:0,opacity:1},exit:{x:-320,opacity:0},transition:{type:"spring",stiffness:260,damping:24},children:m})})};var o=(e,s,a)=>new Promise((i,t)=>{var n=e=>{try{c(a.next(e))}catch(s){t(s)}},l=e=>{try{c(a.throw(e))}catch(s){t(s)}},c=e=>e.done?i(e.value):Promise.resolve(e.value).then(n,l);c((a=a.apply(e,s)).next())});const d=()=>{var d;const{chatId:m}=l();c();const u=e.useRef(null),h=e.useRef(null),[p,j]=e.useState(""),[x,v]=e.useState(!1),[f,N]=e.useState(null),[y,g]=e.useState(null),[b,w]=e.useState(null),[C,k]=e.useState(!1),[S,E]=e.useState(!1),[I,R]=e.useState(!1),[_,L]=e.useState(!1),{user:T,chats:U,messages:A,activeChat:M,setActiveChat:z,addMessage:F,editMessage:P,deleteMessage:D,addReaction:O,markMessagesAsRead:V,loadChatMessages:q,contacts:B}=a(),$=U.find(e=>e.id===M),K=A[M]||[],Q=null==(d=null==$?void 0:$.participants)?void 0:d.find(e=>e!==(null==T?void 0:T.uid)),G=B.find(e=>e.uid===Q);e.useEffect(()=>{var e;null==(e=u.current)||e.scrollIntoView({behavior:"smooth"})},[K]),e.useEffect(()=>{M||v(!0)},[M]);const H=e.useRef(K.length);e.useEffect(()=>{if(!T||K.length<=H.current)return void(H.current=K.length);const e=K[K.length-1];if(e&&e.senderId&&e.senderId!==T.uid)try{i("receive")}catch(s){}H.current=K.length},[K,T]),e.useEffect(()=>{M&&(q(M),V(M))},[M,q,V]);const J=e=>{z(e),v(!1)},W=e=>{if(e.senderId===(null==T?void 0:T.uid))switch(e.status){case"sent":return"✓";case"delivered":case"read":return"✓✓";default:return""}return""},X=["👍","❤️","😂","😮","😢","😡"];return $?s.jsxs("div",{className:"chat-page chat-layout",children:[s.jsx("div",{className:"chat-drawer-desktop",children:s.jsx(r,{pinned:!0,chats:U,contacts:B,messages:A,currentUserId:null==T?void 0:T.uid,onSelectChat:J})}),s.jsxs("div",{className:"chat-header",children:[s.jsx("button",{onClick:()=>{z(null),v(!0)},className:"btn btn-icon btn-outline",children:s.jsx("i",{className:"fas fa-arrow-left"})}),s.jsxs("div",{className:"chat-participant",children:[s.jsx("div",{className:"participant-avatar",children:(null==G?void 0:G.photoURL)?s.jsx("img",{src:G.photoURL,alt:G.displayName}):s.jsx("i",{className:"fas fa-user"})}),s.jsxs("div",{className:"participant-info",children:[s.jsx("h2",{children:(null==G?void 0:G.displayName)||"Utilisateur"}),s.jsx("p",{className:"participant-status",children:I?"En train d'écrire...":"En ligne"})]})]}),s.jsxs("div",{className:"chat-actions",children:[s.jsx("button",{className:"btn btn-icon action-btn",title:"Appel vocal",children:s.jsx("i",{className:"fas fa-phone"})}),s.jsx("button",{className:"btn btn-icon action-btn",title:"Appel vidéo",children:s.jsx("i",{className:"fas fa-video"})}),s.jsx("button",{className:"btn btn-icon action-btn",title:"Plus d'options",children:s.jsx("i",{className:"fas fa-ellipsis-v"})})]})]}),s.jsx("div",{className:"chat-messages",children:s.jsxs("div",{className:"messages-container",children:[s.jsx(t,{children:K.length>0?K.map((e,a)=>{const t=e.senderId===(null==T?void 0:T.uid),l=(null==f?void 0:f.id)===e.id;return s.jsxs(n.div,{className:"message-item "+(t?"own":"other"),initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:-20},transition:{delay:.1*a},children:[e.replyTo&&s.jsxs("div",{className:"reply-to",children:[s.jsx("i",{className:"fas fa-reply"}),s.jsx("span",{children:"Réponse à un message"})]}),s.jsxs("div",{className:"message-content",children:[l?s.jsxs("div",{className:"edit-message",children:[s.jsx("input",{type:"text",defaultValue:e.content,onKeyPress:s=>{var a,i;"Enter"===s.key&&(a=e.id,i=s.target.value,o(void 0,null,function*(){if(i.trim()&&$)try{window.showLoading&&window.showLoading("Modification du message..."),yield P($.id,a,i.trim()),N(null),window.showToast&&window.showToast("Message modifié avec succès","success")}catch(e){window.showError&&window.showError("Erreur lors de la modification du message")}}))},onBlur:()=>N(null),autoFocus:!0}),s.jsx("button",{onClick:()=>N(null),children:s.jsx("i",{className:"fas fa-times"})})]}):s.jsxs(s.Fragment,{children:[s.jsx("p",{children:e.content}),e.edited&&s.jsx("span",{className:"edited-indicator",children:"(modifié)"})]}),s.jsxs("div",{className:"message-meta",children:[s.jsx("span",{className:"message-time",children:(c=e.timestamp,new Date(c).toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"}))}),t&&s.jsx("span",{className:"message-status",children:W(e)})]}),e.reactions&&Object.keys(e.reactions).length>0&&s.jsx("div",{className:"reaction-cluster",children:Object.entries(Object.values(e.reactions).reduce((e,s)=>(e[s]=(e[s]||0)+1,e),{})).map(([e,a])=>s.jsxs("span",{className:"reaction-bubble",children:[s.jsx("span",{className:"emoji",children:e}),s.jsx("span",{className:"count",children:a})]},e))})]}),s.jsxs("div",{className:"message-actions",children:[s.jsx("button",{onClick:()=>w(b===e.id?null:e.id),className:"action-btn",title:"Ajouter une réaction",children:s.jsx("i",{className:"fas fa-smile"})}),t&&s.jsxs(s.Fragment,{children:[s.jsx("button",{onClick:()=>N(e),className:"action-btn",title:"Modifier le message",children:s.jsx("i",{className:"fas fa-edit"})}),s.jsx("button",{onClick:()=>{return s=e.id,o(void 0,null,function*(){if($&&window.confirm("Voulez-vous vraiment supprimer ce message ?"))try{window.showLoading&&window.showLoading("Suppression du message..."),yield D($.id,s),window.showToast&&window.showToast("Message supprimé avec succès","success")}catch(e){window.showError&&window.showError("Erreur lors de la suppression du message")}});var s},className:"action-btn",title:"Supprimer le message",children:s.jsx("i",{className:"fas fa-trash"})})]})]}),b===e.id&&s.jsx(n.div,{className:"reactions-menu",initial:{opacity:0,scale:.8},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.8},children:X.map(a=>s.jsx("button",{onClick:()=>((e,s)=>o(void 0,null,function*(){$&&(yield O($.id,e,{userId:T.uid,emoji:s}),i("reaction"),w(null))}))(e.id,a),className:"reaction-btn",children:a},a))})]},e.id);var c}):s.jsxs(n.div,{className:"empty-messages",initial:{opacity:0},animate:{opacity:1},children:[s.jsx("i",{className:"fas fa-comments"}),s.jsx("h3",{children:"Aucun message"}),s.jsx("p",{children:"Commencez la conversation en envoyant un message !"})]})}),s.jsx("div",{ref:u})]})}),s.jsxs("form",{onSubmit:e=>o(void 0,null,function*(){if(e.preventDefault(),p.trim()&&$){const e={id:`msg_${Date.now()}`,content:p.trim(),senderId:T.uid,timestamp:Date.now(),type:"text",replyTo:(null==y?void 0:y.id)||null};try{window.showLoading&&window.showLoading("Envoi du message..."),yield F($.id,e),i("send"),j(""),g(null),k(!1)}catch(s){window.showError&&window.showError("Erreur lors de l'envoi du message")}}}),className:"chat-input-container",children:[y&&s.jsxs("div",{className:"reply-preview",children:[s.jsxs("div",{className:"reply-content",children:[s.jsx("i",{className:"fas fa-reply"}),s.jsxs("span",{children:["Réponse à : ",y.content]})]}),s.jsx("button",{type:"button",onClick:()=>g(null),className:"btn btn-icon close-btn",title:"Annuler la réponse",children:s.jsx("i",{className:"fas fa-times"})})]}),s.jsxs("div",{className:"message-input-wrapper",children:[s.jsxs("div",{className:"input-actions",children:[s.jsx("button",{type:"button",className:"btn btn-icon action-btn",onClick:()=>E(!S),title:"Pièces jointes",children:s.jsx("i",{className:"fas fa-paperclip"})}),S&&s.jsxs(n.div,{className:"attachment-menu",initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,y:10},children:[s.jsxs("button",{type:"button",onClick:()=>{var e;return null==(e=h.current)?void 0:e.click()},className:"attachment-option",children:[s.jsx("i",{className:"fas fa-image"}),s.jsx("span",{children:"Photo"})]}),s.jsxs("button",{type:"button",onClick:()=>{var e;return null==(e=h.current)?void 0:e.click()},className:"attachment-option",children:[s.jsx("i",{className:"fas fa-video"}),s.jsx("span",{children:"Vidéo"})]}),s.jsxs("button",{type:"button",onClick:()=>{var e;return null==(e=h.current)?void 0:e.click()},className:"attachment-option",children:[s.jsx("i",{className:"fas fa-file"}),s.jsx("span",{children:"Document"})]}),s.jsxs("button",{type:"button",onClick:()=>{var e;return null==(e=h.current)?void 0:e.click()},className:"attachment-option",children:[s.jsx("i",{className:"fas fa-microphone"}),s.jsx("span",{children:"Audio"})]})]}),s.jsx("button",{type:"button",className:"btn btn-icon action-btn",onClick:()=>k(!C),title:"Emojis",children:s.jsx("i",{className:"fas fa-smile"})})]}),s.jsxs("div",{className:"input-field-container",children:[s.jsx("input",{type:"text",value:p,onChange:e=>{j(e.target.value),R(!0),setTimeout(()=>R(!1),1e3)},placeholder:"Tapez votre message...",className:"message-input"}),s.jsx("button",{type:"submit",className:"btn btn-icon send-btn",disabled:!p.trim(),title:"Envoyer",children:s.jsx("i",{className:"fas fa-paper-plane"})})]})]}),C&&s.jsx(n.div,{className:"emoji-picker",initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,y:10},children:s.jsx("div",{className:"emoji-grid",children:["😀","😃","😄","😁","😆","😅","😂","🤣","😊","😇","🙂","🙃","😉","😌","😍","🥰","😘","😗","😙","😚","😋","😛","😝","😜","🤪","🤨","🧐","🤓","😎","🤩","🥳","😏","😒","😞","😔","😟","😕","🙁","☹️","😣","😖","😫","😩","🥺","😢","😭","😤","😠","😡","🤬","🤯","😳","🥵","🥶","😱","😨","😰","😥","😓","🤗","🤔","🤭","🤫","🤥","😶","😐","😑","😯","😦","😧","😮","😲","🥱","😴","🤤","😪","😵","🤐","🥴","🤢","🤮","🤧","😷","🤒","🤕"].map((e,a)=>s.jsx("button",{type:"button",onClick:()=>(e=>{j(s=>s+e),k(!1)})(e),className:"emoji-btn",children:e},a))})}),_&&s.jsxs(n.div,{className:"typing-indicator",initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},children:[s.jsxs("span",{children:[(null==G?void 0:G.displayName)||"Quelqu'un"," est en train d'écrire"]}),s.jsxs("div",{className:"typing-dots",children:[s.jsx("div",{className:"typing-dot"}),s.jsx("div",{className:"typing-dot"}),s.jsx("div",{className:"typing-dot"})]})]}),s.jsx("input",{ref:h,type:"file",onChange:e=>{e.target.files[0]&&E(!1)},style:{display:"none"},accept:"image/*,video/*,audio/*,.pdf,.doc,.docx,.txt"})]}),s.jsx(r,{visible:x,onClose:()=>v(!1),chats:U,contacts:B,messages:A,currentUserId:null==T?void 0:T.uid,onSelectChat:J})]}):s.jsxs("div",{className:"chat-page chat-layout",children:[s.jsx("div",{className:"chat-drawer-desktop",children:s.jsx(r,{pinned:!0,chats:U,contacts:B,messages:A,currentUserId:null==T?void 0:T.uid,onSelectChat:J})}),s.jsx("div",{className:"chat-messages",style:{display:"grid",placeItems:"center"},children:s.jsxs("div",{className:"empty-messages",style:{textAlign:"center"},children:[s.jsx("i",{className:"fas fa-comments",style:{fontSize:48,opacity:.85}}),s.jsx("h3",{style:{marginTop:12},children:"Bienvenue dans CirusChat"}),s.jsx("p",{style:{marginTop:6,color:"var(--muted)"},children:"Sélectionnez un contact à gauche ou créez une nouvelle conversation."}),s.jsx("div",{style:{marginTop:16,display:"flex",gap:8,justifyContent:"center"},children:s.jsx("button",{onClick:()=>v(!0),className:"btn btn-primary",children:"Ouvrir les contacts"})})]})}),s.jsx(r,{visible:x,onClose:()=>v(!1),chats:U,contacts:B,messages:A,currentUserId:null==T?void 0:T.uid,onSelectChat:J})]})};export{d as default};
