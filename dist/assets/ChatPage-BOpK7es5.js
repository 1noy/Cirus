import{r as s}from"./vendor-Be9Gvr8Z.js";import{j as e,u as a,p as i}from"./index-CCLsKoSC.js";import{A as t,m as n}from"./ui-CVUBDUKm.js";import{a as l,u as c}from"./router-WS_FqKV8.js";import"./query-BCFsIYE1.js";import"./virtual-BJqExeNh.js";import"./utils-CkSu2hCt.js";import"./error-BaU7SGNY.js";import"./toast-DAwFn72h.js";import"./state-CH3XQ_Yu.js";import"./firebase-DLJYeIMi.js";const o=({visible:s,onClose:a,chats:i,contacts:l,currentUserId:c,onSelectChat:o,messages:r,pinned:d=!1})=>{const m=e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"drawer__header",children:[e.jsx("h3",{children:"Conversations"}),!d&&e.jsx("button",{className:"btn btn-icon",onClick:a,"aria-label":"Fermer",children:e.jsx("i",{className:"fas fa-times"})})]}),e.jsx("div",{className:"chat-list",children:(null==i?void 0:i.length)?i.map(s=>{var a,i;const t=(s=>{var e;return null==(e=null==s?void 0:s.participants)?void 0:e.find(s=>s!==c)})(s),n=(d=t,null==l?void 0:l.find(s=>s.uid===d));var d;const m=(u=s.id,((null==r?void 0:r[u])||[]).filter(s=>!s.read&&s.senderId!==c).length);var u;return e.jsxs("button",{className:"chat-item",onClick:()=>o(s.id),children:[e.jsx("div",{className:"chat-item__avatar",children:(null==n?void 0:n.photoURL)?e.jsx("img",{src:n.photoURL,alt:n.displayName||"Utilisateur"}):e.jsx("i",{className:"fas fa-user"})}),e.jsxs("div",{className:"chat-item__info",children:[e.jsxs("div",{className:"chat-item__name",children:[(null==n?void 0:n.displayName)||"Utilisateur",(null==n?void 0:n.online)&&e.jsx("span",{style:{marginLeft:8,width:8,height:8,borderRadius:999,background:"var(--accent)",display:"inline-block",boxShadow:"0 0 8px var(--accent)"}})]}),e.jsx("div",{className:"chat-item__meta",children:(null==(i=null==(a=null==s?void 0:s.lastMessage)?void 0:a.content)?void 0:i.slice(0,40))||"Nouvelle conversation"})]}),m>0&&e.jsx("span",{className:"badge-unread","aria-label":`${m} non lus`,children:m}),e.jsx("i",{className:"fas fa-chevron-right chat-item__chev"})]},s.id)}):e.jsx("div",{className:"empty-messages",style:{padding:16},children:"Aucune conversation"})})]});return d?e.jsx("div",{className:"drawer drawer--pinned",children:m}):e.jsx(t,{children:s&&e.jsx(n.aside,{className:"drawer",initial:{x:-320,opacity:0},animate:{x:0,opacity:1},exit:{x:-320,opacity:0},transition:{type:"spring",stiffness:260,damping:24},children:m})})};var r=(s,e,a)=>new Promise((i,t)=>{var n=s=>{try{c(a.next(s))}catch(e){t(e)}},l=s=>{try{c(a.throw(s))}catch(e){t(e)}},c=s=>s.done?i(s.value):Promise.resolve(s.value).then(n,l);c((a=a.apply(s,e)).next())});const d=()=>{var d;const{chatId:m}=l();c();const u=s.useRef(null),h=s.useRef(null),[p,j]=s.useState(""),[x,v]=s.useState(!1),[f,N]=s.useState(null),[y,g]=s.useState(null),[b,w]=s.useState(null),[C,k]=s.useState(!1),[E,S]=s.useState(!1),[R,I]=s.useState(!1),[_,L]=s.useState(!1),{user:U,chats:A,messages:M,activeChat:T,setActiveChat:F,addMessage:P,editMessage:D,deleteMessage:V,addReaction:z,markMessagesAsRead:O,loadChatMessages:q,contacts:$}=a(),B=A.find(s=>s.id===T),K=M[T]||[],Q=null==(d=null==B?void 0:B.participants)?void 0:d.find(s=>s!==(null==U?void 0:U.uid)),G=$.find(s=>s.uid===Q);s.useEffect(()=>{var s;null==(s=u.current)||s.scrollIntoView({behavior:"smooth"})},[K]);const H=s.useRef(K.length);s.useEffect(()=>{if(!U||K.length<=H.current)return void(H.current=K.length);const s=K[K.length-1];if(s&&s.senderId&&s.senderId!==U.uid)try{i("receive")}catch(e){}H.current=K.length},[K,U]),s.useEffect(()=>{T&&(q(T),O(T))},[T,q,O]);const J=s=>{F(s),v(!1)},W=s=>{if(s.senderId===(null==U?void 0:U.uid))switch(s.status){case"sent":return"✓";case"delivered":case"read":return"✓✓";default:return""}return""},X=["👍","❤️","😂","😮","😢","😡"];return B?e.jsxs("div",{className:"chat-page chat-layout",children:[e.jsx("div",{className:"chat-drawer-desktop",children:e.jsx(o,{pinned:!0,chats:A,contacts:$,messages:M,currentUserId:null==U?void 0:U.uid,onSelectChat:J})}),e.jsxs("div",{className:"chat-header",children:[e.jsx("button",{onClick:()=>{F(null),v(!0)},className:"btn btn-icon btn-outline",children:e.jsx("i",{className:"fas fa-arrow-left"})}),e.jsxs("div",{className:"chat-participant",children:[e.jsx("div",{className:"participant-avatar",children:(null==G?void 0:G.photoURL)?e.jsx("img",{src:G.photoURL,alt:G.displayName}):e.jsx("i",{className:"fas fa-user"})}),e.jsxs("div",{className:"participant-info",children:[e.jsx("h2",{children:(null==G?void 0:G.displayName)||"Utilisateur"}),e.jsx("p",{className:"participant-status",children:R?"En train d'écrire...":"En ligne"})]})]}),e.jsxs("div",{className:"chat-actions",children:[e.jsx("button",{className:"btn btn-icon action-btn",title:"Appel vocal",children:e.jsx("i",{className:"fas fa-phone"})}),e.jsx("button",{className:"btn btn-icon action-btn",title:"Appel vidéo",children:e.jsx("i",{className:"fas fa-video"})}),e.jsx("button",{className:"btn btn-icon action-btn",title:"Plus d'options",children:e.jsx("i",{className:"fas fa-ellipsis-v"})})]})]}),e.jsx("div",{className:"chat-messages",children:e.jsxs("div",{className:"messages-container",children:[e.jsx(t,{children:K.length>0?K.map((s,a)=>{const t=s.senderId===(null==U?void 0:U.uid),l=(null==f?void 0:f.id)===s.id;return e.jsxs(n.div,{className:"message-item "+(t?"own":"other"),initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:-20},transition:{delay:.1*a},children:[s.replyTo&&e.jsxs("div",{className:"reply-to",children:[e.jsx("i",{className:"fas fa-reply"}),e.jsx("span",{children:"Réponse à un message"})]}),e.jsxs("div",{className:"message-content",children:[l?e.jsxs("div",{className:"edit-message",children:[e.jsx("input",{type:"text",defaultValue:s.content,onKeyPress:e=>{var a,i;"Enter"===e.key&&(a=s.id,i=e.target.value,r(void 0,null,function*(){if(i.trim()&&B)try{window.showLoading&&window.showLoading("Modification du message..."),yield D(B.id,a,i.trim()),N(null),window.showToast&&window.showToast("Message modifié avec succès","success")}catch(s){window.showError&&window.showError("Erreur lors de la modification du message")}}))},onBlur:()=>N(null),autoFocus:!0}),e.jsx("button",{onClick:()=>N(null),children:e.jsx("i",{className:"fas fa-times"})})]}):e.jsxs(e.Fragment,{children:[e.jsx("p",{children:s.content}),s.edited&&e.jsx("span",{className:"edited-indicator",children:"(modifié)"})]}),e.jsxs("div",{className:"message-meta",children:[e.jsx("span",{className:"message-time",children:(c=s.timestamp,new Date(c).toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"}))}),t&&e.jsx("span",{className:"message-status",children:W(s)})]}),s.reactions&&Object.keys(s.reactions).length>0&&e.jsx("div",{className:"reaction-cluster",children:Object.entries(Object.values(s.reactions).reduce((s,e)=>(s[e]=(s[e]||0)+1,s),{})).map(([s,a])=>e.jsxs("span",{className:"reaction-bubble",children:[e.jsx("span",{className:"emoji",children:s}),e.jsx("span",{className:"count",children:a})]},s))})]}),e.jsxs("div",{className:"message-actions",children:[e.jsx("button",{onClick:()=>w(b===s.id?null:s.id),className:"action-btn",title:"Ajouter une réaction",children:e.jsx("i",{className:"fas fa-smile"})}),t&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>N(s),className:"action-btn",title:"Modifier le message",children:e.jsx("i",{className:"fas fa-edit"})}),e.jsx("button",{onClick:()=>{return e=s.id,r(void 0,null,function*(){if(B&&window.confirm("Voulez-vous vraiment supprimer ce message ?"))try{window.showLoading&&window.showLoading("Suppression du message..."),yield V(B.id,e),window.showToast&&window.showToast("Message supprimé avec succès","success")}catch(s){window.showError&&window.showError("Erreur lors de la suppression du message")}});var e},className:"action-btn",title:"Supprimer le message",children:e.jsx("i",{className:"fas fa-trash"})})]})]}),b===s.id&&e.jsx(n.div,{className:"reactions-menu",initial:{opacity:0,scale:.8},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.8},children:X.map(a=>e.jsx("button",{onClick:()=>((s,e)=>r(void 0,null,function*(){B&&(yield z(B.id,s,{userId:U.uid,emoji:e}),i("reaction"),w(null))}))(s.id,a),className:"reaction-btn",children:a},a))})]},s.id);var c}):e.jsxs(n.div,{className:"empty-messages",initial:{opacity:0},animate:{opacity:1},children:[e.jsx("i",{className:"fas fa-comments"}),e.jsx("h3",{children:"Aucun message"}),e.jsx("p",{children:"Commencez la conversation en envoyant un message !"})]})}),e.jsx("div",{ref:u})]})}),e.jsxs("form",{onSubmit:s=>r(void 0,null,function*(){if(s.preventDefault(),p.trim()&&B){const s={id:`msg_${Date.now()}`,content:p.trim(),senderId:U.uid,timestamp:Date.now(),type:"text",replyTo:(null==y?void 0:y.id)||null};try{window.showLoading&&window.showLoading("Envoi du message..."),yield P(B.id,s),i("send"),j(""),g(null),k(!1)}catch(e){window.showError&&window.showError("Erreur lors de l'envoi du message")}}}),className:"chat-input-container",children:[y&&e.jsxs("div",{className:"reply-preview",children:[e.jsxs("div",{className:"reply-content",children:[e.jsx("i",{className:"fas fa-reply"}),e.jsxs("span",{children:["Réponse à : ",y.content]})]}),e.jsx("button",{type:"button",onClick:()=>g(null),className:"btn btn-icon close-btn",title:"Annuler la réponse",children:e.jsx("i",{className:"fas fa-times"})})]}),e.jsxs("div",{className:"message-input-wrapper",children:[e.jsxs("div",{className:"input-actions",children:[e.jsx("button",{type:"button",className:"btn btn-icon action-btn",onClick:()=>S(!E),title:"Pièces jointes",children:e.jsx("i",{className:"fas fa-paperclip"})}),E&&e.jsxs(n.div,{className:"attachment-menu",initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,y:10},children:[e.jsxs("button",{type:"button",onClick:()=>{var s;return null==(s=h.current)?void 0:s.click()},className:"attachment-option",children:[e.jsx("i",{className:"fas fa-image"}),e.jsx("span",{children:"Photo"})]}),e.jsxs("button",{type:"button",onClick:()=>{var s;return null==(s=h.current)?void 0:s.click()},className:"attachment-option",children:[e.jsx("i",{className:"fas fa-video"}),e.jsx("span",{children:"Vidéo"})]}),e.jsxs("button",{type:"button",onClick:()=>{var s;return null==(s=h.current)?void 0:s.click()},className:"attachment-option",children:[e.jsx("i",{className:"fas fa-file"}),e.jsx("span",{children:"Document"})]}),e.jsxs("button",{type:"button",onClick:()=>{var s;return null==(s=h.current)?void 0:s.click()},className:"attachment-option",children:[e.jsx("i",{className:"fas fa-microphone"}),e.jsx("span",{children:"Audio"})]})]}),e.jsx("button",{type:"button",className:"btn btn-icon action-btn",onClick:()=>k(!C),title:"Emojis",children:e.jsx("i",{className:"fas fa-smile"})})]}),e.jsxs("div",{className:"input-field-container",children:[e.jsx("input",{type:"text",value:p,onChange:s=>{j(s.target.value),I(!0),setTimeout(()=>I(!1),1e3)},placeholder:"Tapez votre message...",className:"message-input"}),e.jsx("button",{type:"submit",className:"btn btn-icon send-btn",disabled:!p.trim(),title:"Envoyer",children:e.jsx("i",{className:"fas fa-paper-plane"})})]})]}),C&&e.jsx(n.div,{className:"emoji-picker",initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,y:10},children:e.jsx("div",{className:"emoji-grid",children:["😀","😃","😄","😁","😆","😅","😂","🤣","😊","😇","🙂","🙃","😉","😌","😍","🥰","😘","😗","😙","😚","😋","😛","😝","😜","🤪","🤨","🧐","🤓","😎","🤩","🥳","😏","😒","😞","😔","😟","😕","🙁","☹️","😣","😖","😫","😩","🥺","😢","😭","😤","😠","😡","🤬","🤯","😳","🥵","🥶","😱","😨","😰","😥","😓","🤗","🤔","🤭","🤫","🤥","😶","😐","😑","😯","😦","😧","😮","😲","🥱","😴","🤤","😪","😵","🤐","🥴","🤢","🤮","🤧","😷","🤒","🤕"].map((s,a)=>e.jsx("button",{type:"button",onClick:()=>(s=>{j(e=>e+s),k(!1)})(s),className:"emoji-btn",children:s},a))})}),_&&e.jsxs(n.div,{className:"typing-indicator",initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},children:[e.jsxs("span",{children:[(null==G?void 0:G.displayName)||"Quelqu'un"," est en train d'écrire"]}),e.jsxs("div",{className:"typing-dots",children:[e.jsx("div",{className:"typing-dot"}),e.jsx("div",{className:"typing-dot"}),e.jsx("div",{className:"typing-dot"})]})]}),e.jsx("input",{ref:h,type:"file",onChange:s=>{s.target.files[0]&&S(!1)},style:{display:"none"},accept:"image/*,video/*,audio/*,.pdf,.doc,.docx,.txt"})]}),e.jsx(o,{visible:x,onClose:()=>v(!1),chats:A,contacts:$,messages:M,currentUserId:null==U?void 0:U.uid,onSelectChat:J})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"chat-error",children:[e.jsx("h3",{children:"Chat non trouvé"}),e.jsx("button",{onClick:()=>v(!0),className:"btn btn-primary",children:"Retour aux contacts"})]}),e.jsx(o,{visible:x,onClose:()=>v(!1),chats:A,contacts:$,currentUserId:null==U?void 0:U.uid,onSelectChat:J})]})};export{d as default};
