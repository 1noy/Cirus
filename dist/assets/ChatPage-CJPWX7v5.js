import{r as s}from"./vendor-Be9Gvr8Z.js";import{j as e,u as a}from"./index-DcW9jZ1P.js";import{A as i,m as t}from"./ui-CVUBDUKm.js";import{a as n,u as l}from"./router-WS_FqKV8.js";import"./query-BCFsIYE1.js";import"./virtual-BJqExeNh.js";import"./utils-CkSu2hCt.js";import"./error-BaU7SGNY.js";import"./toast-DAwFn72h.js";import"./state-CH3XQ_Yu.js";import"./firebase-DLJYeIMi.js";const c=({visible:s,onClose:a,chats:n,contacts:l,currentUserId:c,onSelectChat:o})=>e.jsx(i,{children:s&&e.jsxs(t.aside,{className:"drawer",initial:{x:-320,opacity:0},animate:{x:0,opacity:1},exit:{x:-320,opacity:0},transition:{type:"spring",stiffness:260,damping:24},children:[e.jsxs("div",{className:"drawer__header",children:[e.jsx("h3",{children:"Conversations"}),e.jsx("button",{className:"btn btn-icon",onClick:a,"aria-label":"Fermer",children:e.jsx("i",{className:"fas fa-times"})})]}),e.jsx("div",{className:"chat-list",children:(null==n?void 0:n.length)?n.map(s=>{var a,i;const t=(s=>{var e;return null==(e=null==s?void 0:s.participants)?void 0:e.find(s=>s!==c)})(s),n=(r=t,null==l?void 0:l.find(s=>s.uid===r));var r;return e.jsxs("button",{className:"chat-item",onClick:()=>o(s.id),children:[e.jsx("div",{className:"chat-item__avatar",children:(null==n?void 0:n.photoURL)?e.jsx("img",{src:n.photoURL,alt:n.displayName||"Utilisateur"}):e.jsx("i",{className:"fas fa-user"})}),e.jsxs("div",{className:"chat-item__info",children:[e.jsx("div",{className:"chat-item__name",children:(null==n?void 0:n.displayName)||"Utilisateur"}),e.jsx("div",{className:"chat-item__meta",children:(null==(i=null==(a=null==s?void 0:s.lastMessage)?void 0:a.content)?void 0:i.slice(0,40))||"Nouvelle conversation"})]}),e.jsx("i",{className:"fas fa-chevron-right chat-item__chev"})]},s.id)}):e.jsx("div",{className:"empty-messages",style:{padding:16},children:"Aucune conversation"})})]})});var o=(s,e,a)=>new Promise((i,t)=>{var n=s=>{try{c(a.next(s))}catch(e){t(e)}},l=s=>{try{c(a.throw(s))}catch(e){t(e)}},c=s=>s.done?i(s.value):Promise.resolve(s.value).then(n,l);c((a=a.apply(s,e)).next())});const r=()=>{var r;const{chatId:d}=n();l();const m=s.useRef(null),u=s.useRef(null),[h,p]=s.useState(""),[j,x]=s.useState(!1),[v,N]=s.useState(null),[f,y]=s.useState(null),[b,g]=s.useState(null),[w,C]=s.useState(!1),[k,E]=s.useState(!1),[S,_]=s.useState(!1),[R,L]=s.useState(!1),{user:A,chats:M,messages:U,activeChat:I,setActiveChat:T,addMessage:F,editMessage:P,deleteMessage:D,addReaction:V,markMessagesAsRead:z,loadChatMessages:q,contacts:O}=a(),B=M.find(s=>s.id===I),K=U[I]||[],Q=null==(r=null==B?void 0:B.participants)?void 0:r.find(s=>s!==(null==A?void 0:A.uid)),$=O.find(s=>s.uid===Q);s.useEffect(()=>{var s;null==(s=m.current)||s.scrollIntoView({behavior:"smooth"})},[K]),s.useEffect(()=>{I&&(q(I),z(I))},[I,q,z]);const G=s=>{T(s),x(!1)},H=s=>{if(s.senderId===(null==A?void 0:A.uid))switch(s.status){case"sent":return"✓";case"delivered":case"read":return"✓✓";default:return""}return""},J=["👍","❤️","😂","😮","😢","😡"];return B?e.jsxs("div",{className:"chat-page",children:[e.jsxs("div",{className:"chat-header",children:[e.jsx("button",{onClick:()=>{T(null),x(!0)},className:"btn btn-icon btn-outline",children:e.jsx("i",{className:"fas fa-arrow-left"})}),e.jsxs("div",{className:"chat-participant",children:[e.jsx("div",{className:"participant-avatar",children:(null==$?void 0:$.photoURL)?e.jsx("img",{src:$.photoURL,alt:$.displayName}):e.jsx("i",{className:"fas fa-user"})}),e.jsxs("div",{className:"participant-info",children:[e.jsx("h2",{children:(null==$?void 0:$.displayName)||"Utilisateur"}),e.jsx("p",{className:"participant-status",children:S?"En train d'écrire...":"En ligne"})]})]}),e.jsxs("div",{className:"chat-actions",children:[e.jsx("button",{className:"btn btn-icon action-btn",title:"Appel vocal",children:e.jsx("i",{className:"fas fa-phone"})}),e.jsx("button",{className:"btn btn-icon action-btn",title:"Appel vidéo",children:e.jsx("i",{className:"fas fa-video"})}),e.jsx("button",{className:"btn btn-icon action-btn",title:"Plus d'options",children:e.jsx("i",{className:"fas fa-ellipsis-v"})})]})]}),e.jsx("div",{className:"chat-messages",children:e.jsxs("div",{className:"messages-container",children:[e.jsx(i,{children:K.length>0?K.map((s,a)=>{const i=s.senderId===(null==A?void 0:A.uid),n=(null==v?void 0:v.id)===s.id;return e.jsxs(t.div,{className:"message-item "+(i?"own":"other"),initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:-20},transition:{delay:.1*a},children:[s.replyTo&&e.jsxs("div",{className:"reply-to",children:[e.jsx("i",{className:"fas fa-reply"}),e.jsx("span",{children:"Réponse à un message"})]}),e.jsxs("div",{className:"message-content",children:[n?e.jsxs("div",{className:"edit-message",children:[e.jsx("input",{type:"text",defaultValue:s.content,onKeyPress:e=>{var a,i;"Enter"===e.key&&(a=s.id,i=e.target.value,o(void 0,null,function*(){if(i.trim()&&B)try{window.showLoading&&window.showLoading("Modification du message..."),yield P(B.id,a,i.trim()),N(null),window.showToast&&window.showToast("Message modifié avec succès","success")}catch(s){window.showError&&window.showError("Erreur lors de la modification du message")}}))},onBlur:()=>N(null),autoFocus:!0}),e.jsx("button",{onClick:()=>N(null),children:e.jsx("i",{className:"fas fa-times"})})]}):e.jsxs(e.Fragment,{children:[e.jsx("p",{children:s.content}),s.edited&&e.jsx("span",{className:"edited-indicator",children:"(modifié)"})]}),e.jsxs("div",{className:"message-meta",children:[e.jsx("span",{className:"message-time",children:(l=s.timestamp,new Date(l).toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"}))}),i&&e.jsx("span",{className:"message-status",children:H(s)})]}),s.reactions&&Object.keys(s.reactions).length>0&&e.jsx("div",{className:"message-reactions",children:Object.entries(s.reactions).map(([s,a])=>e.jsx("span",{className:"reaction",children:a},s))})]}),e.jsxs("div",{className:"message-actions",children:[e.jsx("button",{onClick:()=>g(b===s.id?null:s.id),className:"action-btn",title:"Ajouter une réaction",children:e.jsx("i",{className:"fas fa-smile"})}),i&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>N(s),className:"action-btn",title:"Modifier le message",children:e.jsx("i",{className:"fas fa-edit"})}),e.jsx("button",{onClick:()=>{return e=s.id,o(void 0,null,function*(){if(B&&window.confirm("Voulez-vous vraiment supprimer ce message ?"))try{window.showLoading&&window.showLoading("Suppression du message..."),yield D(B.id,e),window.showToast&&window.showToast("Message supprimé avec succès","success")}catch(s){window.showError&&window.showError("Erreur lors de la suppression du message")}});var e},className:"action-btn",title:"Supprimer le message",children:e.jsx("i",{className:"fas fa-trash"})})]})]}),b===s.id&&e.jsx(t.div,{className:"reactions-menu",initial:{opacity:0,scale:.8},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.8},children:J.map(a=>e.jsx("button",{onClick:()=>((s,e)=>o(void 0,null,function*(){B&&(yield V(B.id,s,{userId:A.uid,emoji:e}),g(null))}))(s.id,a),className:"reaction-btn",children:a},a))})]},s.id);var l}):e.jsxs(t.div,{className:"empty-messages",initial:{opacity:0},animate:{opacity:1},children:[e.jsx("i",{className:"fas fa-comments"}),e.jsx("h3",{children:"Aucun message"}),e.jsx("p",{children:"Commencez la conversation en envoyant un message !"})]})}),e.jsx("div",{ref:m})]})}),e.jsxs("form",{onSubmit:s=>o(void 0,null,function*(){if(s.preventDefault(),h.trim()&&B){const s={id:`msg_${Date.now()}`,content:h.trim(),senderId:A.uid,timestamp:Date.now(),type:"text",replyTo:(null==f?void 0:f.id)||null};try{window.showLoading&&window.showLoading("Envoi du message..."),yield F(B.id,s),p(""),y(null),C(!1)}catch(e){window.showError&&window.showError("Erreur lors de l'envoi du message")}}}),className:"chat-input-container",children:[f&&e.jsxs("div",{className:"reply-preview",children:[e.jsxs("div",{className:"reply-content",children:[e.jsx("i",{className:"fas fa-reply"}),e.jsxs("span",{children:["Réponse à : ",f.content]})]}),e.jsx("button",{type:"button",onClick:()=>y(null),className:"btn btn-icon close-btn",title:"Annuler la réponse",children:e.jsx("i",{className:"fas fa-times"})})]}),e.jsxs("div",{className:"message-input-wrapper",children:[e.jsxs("div",{className:"input-actions",children:[e.jsx("button",{type:"button",className:"btn btn-icon action-btn",onClick:()=>E(!k),title:"Pièces jointes",children:e.jsx("i",{className:"fas fa-paperclip"})}),k&&e.jsxs(t.div,{className:"attachment-menu",initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,y:10},children:[e.jsxs("button",{type:"button",onClick:()=>{var s;return null==(s=u.current)?void 0:s.click()},className:"attachment-option",children:[e.jsx("i",{className:"fas fa-image"}),e.jsx("span",{children:"Photo"})]}),e.jsxs("button",{type:"button",onClick:()=>{var s;return null==(s=u.current)?void 0:s.click()},className:"attachment-option",children:[e.jsx("i",{className:"fas fa-video"}),e.jsx("span",{children:"Vidéo"})]}),e.jsxs("button",{type:"button",onClick:()=>{var s;return null==(s=u.current)?void 0:s.click()},className:"attachment-option",children:[e.jsx("i",{className:"fas fa-file"}),e.jsx("span",{children:"Document"})]}),e.jsxs("button",{type:"button",onClick:()=>{var s;return null==(s=u.current)?void 0:s.click()},className:"attachment-option",children:[e.jsx("i",{className:"fas fa-microphone"}),e.jsx("span",{children:"Audio"})]})]}),e.jsx("button",{type:"button",className:"btn btn-icon action-btn",onClick:()=>C(!w),title:"Emojis",children:e.jsx("i",{className:"fas fa-smile"})})]}),e.jsxs("div",{className:"input-field-container",children:[e.jsx("input",{type:"text",value:h,onChange:s=>{p(s.target.value),_(!0),setTimeout(()=>_(!1),1e3)},placeholder:"Tapez votre message...",className:"message-input"}),e.jsx("button",{type:"submit",className:"btn btn-icon send-btn",disabled:!h.trim(),title:"Envoyer",children:e.jsx("i",{className:"fas fa-paper-plane"})})]})]}),w&&e.jsx(t.div,{className:"emoji-picker",initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,y:10},children:e.jsx("div",{className:"emoji-grid",children:["😀","😃","😄","😁","😆","😅","😂","🤣","😊","😇","🙂","🙃","😉","😌","😍","🥰","😘","😗","😙","😚","😋","😛","😝","😜","🤪","🤨","🧐","🤓","😎","🤩","🥳","😏","😒","😞","😔","😟","😕","🙁","☹️","😣","😖","😫","😩","🥺","😢","😭","😤","😠","😡","🤬","🤯","😳","🥵","🥶","😱","😨","😰","😥","😓","🤗","🤔","🤭","🤫","🤥","😶","😐","😑","😯","😦","😧","😮","😲","🥱","😴","🤤","😪","😵","🤐","🥴","🤢","🤮","🤧","😷","🤒","🤕"].map((s,a)=>e.jsx("button",{type:"button",onClick:()=>(s=>{p(e=>e+s),C(!1)})(s),className:"emoji-btn",children:s},a))})}),R&&e.jsxs(t.div,{className:"typing-indicator",initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},children:[e.jsxs("span",{children:[(null==$?void 0:$.displayName)||"Quelqu'un"," est en train d'écrire"]}),e.jsxs("div",{className:"typing-dots",children:[e.jsx("div",{className:"typing-dot"}),e.jsx("div",{className:"typing-dot"}),e.jsx("div",{className:"typing-dot"})]})]}),e.jsx("input",{ref:u,type:"file",onChange:s=>{s.target.files[0]&&E(!1)},style:{display:"none"},accept:"image/*,video/*,audio/*,.pdf,.doc,.docx,.txt"})]}),e.jsx(c,{visible:j,onClose:()=>x(!1),chats:M,contacts:O,currentUserId:null==A?void 0:A.uid,onSelectChat:G})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"chat-error",children:[e.jsx("h3",{children:"Chat non trouvé"}),e.jsx("button",{onClick:()=>x(!0),className:"btn btn-primary",children:"Retour aux contacts"})]}),e.jsx(c,{visible:j,onClose:()=>x(!1),chats:M,contacts:O,currentUserId:null==A?void 0:A.uid,onSelectChat:G})]})};export{r as default};
