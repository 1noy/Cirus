var e=Object.defineProperty,t=Object.getOwnPropertySymbols,n=Object.prototype.hasOwnProperty,s=Object.prototype.propertyIsEnumerable,i=(t,n,s)=>n in t?e(t,n,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[n]=s,a=(e,a)=>{for(var l in a||(a={}))n.call(a,l)&&i(e,l,a[l]);if(t)for(var l of t(a))s.call(a,l)&&i(e,l,a[l]);return e},l=(e,t,n)=>new Promise((s,i)=>{var a=e=>{try{r(n.next(e))}catch(t){i(t)}},l=e=>{try{r(n.throw(e))}catch(t){i(t)}},r=e=>e.done?s(e.value):Promise.resolve(e.value).then(a,l);r((n=n.apply(e,t)).next())});import{r,b as o}from"./vendor-Be9Gvr8Z.js";import{d,s as c,j as u,u as p,_ as h}from"./index-B4H7yEPt.js";import{f as m,m as g,u as v,q as f,w as y,j as x,o as j,J as b,K as w,L as N,M,n as C,N as D,s as S,k as I,O as T}from"./firebase-ChMdDr2b.js";import{s as R,l as O}from"./userService-D0VJv4Sa.js";import"./router-hF8yxhrd.js";import"./query-BCFsIYE1.js";import"./virtual-BJqExeNh.js";import"./utils-CkSu2hCt.js";import"./error-BaU7SGNY.js";import"./toast-DAwFn72h.js";import"./state-CH3XQ_Yu.js";const k=(e,t)=>{const n=f(x(d,"chats"),y("participants","array-contains",e));return g(n,e=>{const n=[];e.forEach(e=>n.push(a({id:e.id},e.data()))),n.sort((e,t)=>(t.lastMessageAt||0)-(e.lastMessageAt||0)),t(n)})},E=(e,t)=>{if(!e)return()=>{};const n=m(d,"chats",e);return g(n,e=>{t(e.exists()?a({id:e.id},e.data()):null)})},A=(e,t)=>l(void 0,null,function*(){const n=f(x(d,"chats"),y("type","==","dm"),y("participants","array-contains",e)),s=yield I(n);for(const e of s.docs){const n=a({id:e.id},e.data());if(n.participants.includes(t))return n.id}return(yield C(x(d,"chats"),{type:"dm",participants:[e,t],createdAt:Date.now(),lastMessage:null,lastMessageAt:Date.now()})).id}),P=(e,t,n)=>l(void 0,null,function*(){return(yield C(x(d,"chats"),{type:"group",title:t,participants:Array.from(new Set([e,...n])),createdAt:Date.now(),lastMessage:null,lastMessageAt:Date.now()})).id}),_=(e,t)=>{const n=f(x(d,"chats",e,"messages"),j("timestamp","asc"));return g(n,e=>{const n=[];e.forEach(e=>n.push(a({id:e.id},e.data()))),t(n)})},L=(e,t=50,n)=>{const s=f(x(d,"chats",e,"messages"),j("timestamp","desc"),b(t));return g(s,n)},F=(e,t,n=50)=>l(void 0,null,function*(){if(!t)return{docs:[]};const s=f(x(d,"chats",e,"messages"),j("timestamp","desc"),T(t),b(n));return yield I(s)}),U=(e,t,n,s=null)=>l(void 0,null,function*(){const i={content:n,senderId:t,timestamp:D(),type:"text",status:"sent",replyTo:s||null};yield C(x(d,"chats",e,"messages"),i),yield v(m(d,"chats",e),{lastMessage:n,lastMessageAt:Date.now()})}),$=(e,t,n)=>l(void 0,null,function*(){const s=`uploads/${e}/${Date.now()}_${n.name}`,i=w(c,s);yield N(i,n);const a={content:yield M(i),senderId:t,timestamp:D(),type:"media",fileName:n.name,size:n.size,mimeType:n.type,status:"sent"};yield C(x(d,"chats",e,"messages"),a),yield v(m(d,"chats",e),{lastMessage:"Fichier mÃ©dia",lastMessageAt:Date.now()})}),z=(e,t,n,s)=>l(void 0,null,function*(){const i=m(d,"chats",e,"messages",t);yield v(i,{[`reactions.${n}`]:s})}),B=(e,t,n)=>l(void 0,null,function*(){const s=m(d,"chats",e,"messages",t);yield v(s,{content:n,edited:!0,editedAt:Date.now()})}),V=(e,t)=>l(void 0,null,function*(){const n=m(d,"chats",e,"messages",t);yield v(n,{content:"Message supprimÃ©",deleted:!0,deletedAt:Date.now()})}),H=(e,t,n)=>l(void 0,null,function*(){const s=m(d,"chats",e,"messages",t);yield v(s,{[`reads.${n}`]:!0})}),Y=(e,t)=>{const n=e.reads||{};return Object.entries(n).some(([e,n])=>e!==t&&n)},q=e=>l(void 0,null,function*(){yield v(m(d,"chats",e),{pinned:null})}),G=(e,t=24)=>l(void 0,null,function*(){const n=f(x(d,"chats",e,"messages"),y("type","==","media"),j("timestamp","desc"),b(t));return(yield I(n)).docs.map(e=>a({id:e.id},e.data()))}),J=(e,t,n)=>l(void 0,null,function*(){yield S(m(d,"chats",e,"typing",t),{typing:!!n,updatedAt:Date.now()})}),K=(e,t)=>g(x(d,"chats",e,"typing"),e=>{const n={};e.forEach(e=>n[e.id]=e.data().typing),t(n)}),Q=Object.freeze(Object.defineProperty({__proto__:null,addReactionToMessage:z,createChannel:(e,t)=>l(void 0,null,function*(){return(yield C(x(d,"chats"),{type:"channel",title:t,ownerId:e,participants:[e],createdAt:Date.now(),lastMessage:null,lastMessageAt:Date.now()})).id}),createGroupChat:P,deleteMessage:V,editMessage:B,ensureDMChat:A,fetchOlderMessages:F,fetchRecentMedia:G,fetchRecentMessages:(e,t=50)=>l(void 0,null,function*(){const n=f(x(d,"chats",e,"messages"),j("timestamp","desc"),b(t));return yield I(n)}),isMessageReadByOthers:Y,listenChatById:E,listenMessages:_,listenRecentMessages:L,listenTyping:K,listenUserChats:k,markRead:H,pinMessage:(e,t)=>l(void 0,null,function*(){var n;yield v(m(d,"chats",e),{pinned:{id:t.id,content:(null==(n=t.content)?void 0:n.slice(0,140))||"",senderId:t.senderId,timestamp:Date.now(),type:t.type||"text"}})}),sendMediaMessage:$,sendTextMessage:U,setTyping:J,unpinMessage:q},Symbol.toStringTag,{value:"Module"})),W=e=>{var t,n;if(!e)return"?";const s=e.split(" ").filter(Boolean);return(((null==(t=s[0])?void 0:t[0])||"")+((null==(n=s[1])?void 0:n[0])||"")).toUpperCase()},X=({size:e=36,name:t,src:n})=>{const s={width:e,height:e,borderRadius:"50%",background:"#333",color:"#fff",display:"inline-flex",alignItems:"center",justifyContent:"center",fontWeight:700,fontSize:Math.max(12,Math.floor(e/3)),overflow:"hidden"};return n?u.jsx("img",{src:n,alt:t,style:s}):u.jsx("div",{style:s,children:W(t)})};var Z=(e,t,n)=>new Promise((s,i)=>{var a=e=>{try{r(n.next(e))}catch(t){i(t)}},l=e=>{try{r(n.throw(e))}catch(t){i(t)}},r=e=>e.done?s(e.value):Promise.resolve(e.value).then(a,l);r((n=n.apply(e,t)).next())});const ee=({onOpenChat:e,activeChatId:t})=>{const{user:n}=p(),[s,i]=r.useState([]),[a,l]=r.useState(""),[o,d]=r.useState([]);return r.useEffect(()=>{if(!n)return;const e=k(n.uid,i);return()=>e&&e()},[n]),u.jsxs("div",{className:"tg-sidebar",children:[u.jsx("div",{className:"tg-search",children:u.jsx("input",{placeholder:"Rechercher",value:a,onChange:e=>Z(void 0,null,function*(){const t=e.target.value;if(l(t),t.length>=3){const e=yield R(t);d(e.filter(e=>e.uid!==(null==n?void 0:n.uid)))}else d([])})})}),u.jsxs("div",{className:"tg-sidebar-actions",children:[u.jsx("button",{onClick:()=>Z(void 0,null,function*(){const t=prompt("UID du contact ?");if(!t)return;const s=yield A(n.uid,t);e(s)}),children:"Nouveau message"}),u.jsx("button",{onClick:()=>Z(void 0,null,function*(){const t=prompt("Nom du groupe ?"),s=prompt("UID membres sÃ©parÃ©s par des virgules"),i=s?s.split(",").map(e=>e.trim()).filter(Boolean):[],a=yield P(n.uid,t||"Groupe",i);e(a)}),children:"Nouveau groupe"}),u.jsx("button",{onClick:()=>Z(void 0,null,function*(){const t=prompt("Nom du canal ?");if(!t)return;const{createChannel:s}=yield h(()=>Promise.resolve().then(()=>Q),void 0),i=yield s(n.uid,t);e(i)}),children:"Nouveau canal"})]}),u.jsxs("div",{className:"tg-chat-list",children:[o.length>0&&u.jsxs("div",{children:[u.jsx("div",{style:{padding:"4px 12px",color:"#888",fontSize:12},children:"Utilisateurs"}),o.map(t=>u.jsxs("div",{onClick:()=>Z(void 0,null,function*(){const s=yield A(n.uid,t.uid);e(s)}),className:"tg-chat-item",children:[u.jsx(X,{name:t.displayName,src:t.photoURL}),u.jsxs("div",{children:[u.jsx("div",{className:"tg-chat-item-title",children:t.displayName}),u.jsx("div",{className:"tg-chat-item-sub",children:t.email||"â€”"})]})]},t.uid))]}),s.filter(e=>!a||(e.title||e.lastMessage||"").toLowerCase().includes(a.toLowerCase())).map(n=>u.jsxs("div",{onClick:()=>e(n.id),className:"tg-chat-item",style:n.id===t?{background:"rgba(255,255,255,0.05)"}:void 0,children:[u.jsx(X,{name:n.title||"DM"}),u.jsxs("div",{children:[u.jsx("div",{className:"tg-chat-item-title",children:"group"===n.type?n.title||"Groupe":"channel"===n.type?n.title||"Canal":"Message direct"}),u.jsx("div",{className:"tg-chat-item-sub",children:n.lastMessage||"Aucun message"})]})]},n.id))]})]})},te=e=>e?(null==e?void 0:e.toDate)?e.toDate():new Date(e):null,ne=(e,t)=>!(!e||!t)&&e.getFullYear()===t.getFullYear()&&e.getMonth()===t.getMonth()&&e.getDate()===t.getDate(),se=e=>{const t=te(e);return t?t.toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"}):""},ie=e=>{const t=te(e);if(!t)return"";const n=new Date,s=new Date;return s.setDate(n.getDate()-1),ne(t,n)?"Aujourd'hui":ne(t,s)?"Hier":t.toLocaleDateString("fr-FR",{weekday:"long",day:"2-digit",month:"long",year:"numeric"})},ae=(e,t)=>{if(e)return"En ligne";const n=te(t);if(!n)return"Hors ligne";const s=Math.floor((Date.now()-n.getTime())/1e3);return s<60?"Vu Ã  l'instant":s<3600?`Vu il y a ${Math.floor(s/60)} min`:s<86400?`Vu il y a ${Math.floor(s/3600)} h`:`Vu le ${n.toLocaleDateString("fr-FR")} Ã  ${n.toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"})}`},le=["ðŸ‘","â¤ï¸","ðŸ˜‚","ðŸ”¥","ðŸŽ‰"],re=({onReact:e})=>u.jsx("div",{style:{display:"flex",gap:6},children:le.map(t=>u.jsx("button",{onClick:()=>e(t),style:{padding:"2px 6px"},children:t},t))}),oe=e=>"tg-bubble"+(e?" me":""),de=({text:e})=>u.jsx("div",{style:{borderLeft:"2px solid #888",paddingLeft:8,marginBottom:6,color:"#ddd"},children:null==e?void 0:e.slice(0,120)}),ce=({message:e,mine:t,onReact:n,onReply:s,onEdit:i,onDelete:a,currentUserId:l})=>{const[o,d]=r.useState(!1),[c,p]=r.useState(e.content),h=e.reactions?Object.entries(e.reactions).reduce((e,[t,n])=>(e[n]=(e[n]||0)+1,e),{}):null;return u.jsxs("div",{className:"tg-msg"+(t?" me":""),children:[!t&&u.jsx("div",{className:"tg-avatar",children:u.jsx(X,{name:e.senderName||"Utilisateur"})}),u.jsxs("div",{className:"tg-bubble-wrap",children:[!t&&e.senderName&&u.jsx("div",{className:"tg-name",children:e.senderName}),u.jsxs("div",{className:oe(t),children:[e.replyToText&&u.jsx("div",{className:"tg-quote",children:u.jsx(de,{text:e.replyToText})}),e.deleted?u.jsx("i",{style:{color:"#ccc"},children:e.content}):o?u.jsx("form",{onSubmit:e=>{e.preventDefault(),i(c),d(!1)},children:u.jsx("input",{value:c,onChange:e=>p(e.target.value),style:{width:"100%"}})}):"media"===e.type?u.jsxs("span",{className:"tg-file",children:[u.jsx("span",{role:"img","aria-label":"file",children:"ðŸ“Ž"}),u.jsx("a",{href:e.content,target:"_blank",rel:"noreferrer",children:"Fichier"})]}):e.content]}),u.jsxs("div",{className:"tg-meta",children:[se(e.timestamp),e.edited?" â€¢ modifiÃ©":""," ",t&&Y(e,l)?" â€¢ âœ“âœ“":""]}),!e.deleted&&u.jsxs("div",{className:"tg-actions",children:[u.jsx("button",{onClick:s,children:"RÃ©pondre"}),u.jsx(re,{onReact:n}),t&&!o&&u.jsx("button",{onClick:()=>d(!0),children:"Modifier"}),t&&u.jsx("button",{onClick:a,children:"Supprimer"}),t&&u.jsx("button",{onClick:()=>{var t;return null==(t=window.__pin)?void 0:t.call(window,e)},children:"Ã‰pingler"})]}),h&&u.jsx("div",{style:{color:"#aaa",fontSize:12,marginTop:4,display:"flex",gap:8},children:Object.entries(h).map(([e,t])=>u.jsxs("span",{style:{background:"rgba(255,255,255,0.06)",border:"1px solid #333",borderRadius:12,padding:"2px 8px"},children:[e," ",t]},e))})]})]})},ue=({timestamp:e})=>u.jsx("div",{style:{textAlign:"center",margin:"16px 0",color:"#aaa"},children:u.jsx("span",{style:{background:"#111",padding:"4px 8px",borderRadius:12,border:"1px solid #333"},children:ie(e)})});var pe=Object.defineProperty,he=Object.getOwnPropertySymbols,me=Object.prototype.hasOwnProperty,ge=Object.prototype.propertyIsEnumerable,ve=(e,t,n)=>t in e?pe(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;const fe=({chatId:e,currentUserId:t,onReact:n,onReply:s,onEdit:i,onDelete:a})=>{const[l,d]=r.useState([]),[c,p]=r.useState([]),[h,m]=r.useState(null),[g,v]=r.useState(!0),f=r.useRef(null);r.useEffect(()=>{if(!e)return;const t=L(e,50,e=>{d(e.docs),m(e.docs[e.docs.length-1])});return()=>t&&t()},[e]),r.useEffect(()=>{const e=l.map(e=>((e,t)=>{for(var n in t||(t={}))me.call(t,n)&&ve(e,n,t[n]);if(he)for(var n of he(t))ge.call(t,n)&&ve(e,n,t[n]);return e})({id:e.id},e.data()));e.reverse(),p(e)},[l]);const y=e=>e?"function"==typeof e.toDate?e.toDate():e instanceof Date?e:"number"==typeof e?new Date(e):null:null;return u.jsx("div",{ref:f,onScroll:t=>{var n;t.currentTarget.scrollTop<=0&&(n=function*(){if(!g)return;const t=yield F(e,h,50);0!==t.docs.length?(m(t.docs[t.docs.length-1]),d(e=>[...t.docs,...e])):v(!1)},new Promise((e,s)=>{var i=e=>{try{l(n.next(e))}catch(t){s(t)}},a=e=>{try{l(n.throw(e))}catch(t){s(t)}},l=t=>t.done?e(t.value):Promise.resolve(t.value).then(i,a);l((n=n.apply(void 0,null)).next())}))},className:"tg-messages",children:c.map((e,l,r)=>{const d=r[l-1],c=y(null==d?void 0:d.timestamp),p=y(e.timestamp),h=!(d&&(m=c,g=p,m&&g&&m.getFullYear()===g.getFullYear()&&m.getMonth()===g.getMonth()&&m.getDate()===g.getDate()));var m,g;return u.jsxs(o.Fragment,{children:[h&&u.jsx(ue,{timestamp:e.timestamp}),u.jsx(ce,{message:e,mine:e.senderId===t,currentUserId:t,onReact:t=>n(e,t),onReply:()=>s(e),onEdit:t=>i(e,t),onDelete:()=>a(e)})]},e.id)})})},ye=({onSend:e,onFile:t,replyTo:n,onCancelReply:s,onChangeTyping:i})=>{var a;const l=r.useRef(null);return u.jsxs("form",{onSubmit:t=>{t.preventDefault();const n=l.current.value.trim();n&&(e(n),l.current.value="")},className:"tg-input",children:[n&&u.jsxs("div",{className:"tg-reply",children:["RÃ©ponse Ã : ",null==(a=n.content)?void 0:a.slice(0,60)," ",u.jsx("button",{type:"button",onClick:s,children:"x"})]}),u.jsx("input",{ref:l,placeholder:"Ã‰crire un message",onChange:i}),u.jsx("input",{type:"file",onChange:e=>{var n;return(null==(n=e.target.files)?void 0:n[0])&&t(e.target.files[0])}}),u.jsx("button",{type:"submit",children:"Envoyer"})]})},xe=()=>u.jsx("div",{className:"tg-msg",children:u.jsx("div",{className:"tg-bubble-wrap",children:u.jsx("div",{className:"tg-bubble",children:u.jsxs("span",{className:"tg-typing-dots",children:[u.jsx("span",{}),u.jsx("span",{}),u.jsx("span",{})]})})})});var je=Object.defineProperty,be=Object.defineProperties,we=Object.getOwnPropertyDescriptors,Ne=Object.getOwnPropertySymbols,Me=Object.prototype.hasOwnProperty,Ce=Object.prototype.propertyIsEnumerable,De=(e,t,n)=>t in e?je(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,Se=(e,t,n)=>new Promise((s,i)=>{var a=e=>{try{r(n.next(e))}catch(t){i(t)}},l=e=>{try{r(n.throw(e))}catch(t){i(t)}},r=e=>e.done?s(e.value):Promise.resolve(e.value).then(a,l);r((n=n.apply(e,t)).next())});const Ie=({chatId:e,chatMeta:t})=>{const{user:n}=p(),[s,i]=r.useState([]),[a,l]=r.useState({});r.useRef(null);const o=r.useRef(null),[d,c]=r.useState(null);r.useEffect(()=>{if(!e)return;const t=_(e,i),n=K(e,l);return()=>{t&&t(),n&&n()}},[e]),r.useEffect(()=>{o.current&&(o.current.scrollTop=o.current.scrollHeight)},[s]);const h=Object.entries(a).some(([e,t])=>e!==n.uid&&t);return r.useEffect(()=>{s.forEach(t=>{t.senderId!==n.uid&&H(e,t.id,n.uid).catch(()=>{})})},[s,e,n]),r.useMemo(()=>{const e=new Map(s.map(e=>[e.id,e]));return s.map(t=>{var n,s,i;return s=((e,t)=>{for(var n in t||(t={}))Me.call(t,n)&&De(e,n,t[n]);if(Ne)for(var n of Ne(t))Ce.call(t,n)&&De(e,n,t[n]);return e})({},t),i={replyToText:t.replyTo?null==(n=e.get(t.replyTo))?void 0:n.content:void 0},be(s,we(i))})},[s]),u.jsxs("div",{style:{display:"flex",flexDirection:"column",height:"100%"},children:[u.jsx(fe,{chatId:e,currentUserId:n.uid,onReact:(t,s)=>z(e,t.id,n.uid,s),onReply:e=>c(e),onEdit:(t,n)=>B(e,t.id,n),onDelete:t=>V(e,t.id)}),h&&u.jsx(xe,{}),u.jsx(ye,{onSend:t=>Se(void 0,null,function*(){yield U(e,n.uid,t,(null==d?void 0:d.id)||null),c(null),yield J(e,n.uid,!1)}),onFile:t=>Se(void 0,null,function*(){t&&(yield $(e,n.uid,t))}),replyTo:d,onCancelReply:()=>c(null),onChangeTyping:()=>Se(void 0,null,function*(){yield J(e,n.uid,!0),setTimeout(()=>J(e,n.uid,!1),1500)})}),u.jsx("script",{dangerouslySetInnerHTML:{__html:"window.__pin = (m) => { fetch('/pin', { method: 'POST' }).catch(()=>{}); };"}})]})},Te=e=>l(void 0,null,function*(){e&&(yield S(m(d,"presence",e),{online:!1,lastActive:D()},{merge:!0}))}),Re=({chatMeta:e,peerUser:t,presenceText:n,onLogout:s,onToggleInfo:i})=>u.jsxs("div",{className:"tg-header",children:[u.jsxs("div",{className:"tg-header-left",children:[u.jsx(X,{name:(null==t?void 0:t.displayName)||(null==e?void 0:e.title)||"Chat",src:null==t?void 0:t.photoURL}),u.jsxs("div",{className:"tg-header-titles",children:[u.jsx("div",{className:"tg-header-title",children:"dm"===(null==e?void 0:e.type)?(null==t?void 0:t.displayName)||"Message direct":(null==e?void 0:e.title)||(null==e?void 0:e.type)||"Chat"}),u.jsx("div",{className:"tg-header-subtitle",children:n})]})]}),u.jsxs("div",{className:"tg-header-actions",children:[u.jsx("button",{className:"tg-btn",onClick:i,title:"Infos",children:"Infos"}),u.jsx("button",{className:"tg-btn",onClick:s,title:"DÃ©connexion",children:"Quitter"})]})]}),Oe=({chatId:e})=>{const[t,n]=r.useState([]);return r.useEffect(()=>{e&&G(e).then(n).catch(()=>n([]))},[e]),t.length?u.jsx("div",{style:{display:"grid",gridTemplateColumns:"repeat(3, 1fr)",gap:6,padding:12},children:t.map(e=>u.jsx("a",{href:e.content,target:"_blank",rel:"noreferrer",style:{display:"block",borderRadius:8,overflow:"hidden",border:"1px solid #242428"},children:u.jsx("img",{src:e.content,alt:"media",style:{width:"100%",height:96,objectFit:"cover",display:"block"}})},e.id))}):u.jsx("div",{style:{padding:12,color:"#999"},children:"Aucun mÃ©dia rÃ©cent"})},ke=({chatMeta:e,visible:t,onClose:n})=>{var s;const[i,a]=r.useState("info");return t?u.jsxs("div",{className:"tg-info",children:[u.jsxs("div",{className:"tg-info-header",children:[u.jsx("div",{children:"Infos de la conversation"}),u.jsx("button",{className:"tg-btn",onClick:n,children:"Fermer"})]}),u.jsxs("div",{className:"tg-info-body",children:[u.jsxs("div",{style:{display:"flex",gap:8,marginBottom:8},children:[u.jsx("button",{className:"tg-btn",onClick:()=>a("info"),disabled:"info"===i,children:"Infos"}),u.jsx("button",{className:"tg-btn",onClick:()=>a("media"),disabled:"media"===i,children:"MÃ©dias"})]}),"info"===i?u.jsxs(u.Fragment,{children:[u.jsxs("div",{className:"tg-info-row",children:[u.jsx("b",{children:"Type"}),": ",null==e?void 0:e.type]}),(null==e?void 0:e.title)&&u.jsxs("div",{className:"tg-info-row",children:[u.jsx("b",{children:"Titre"}),": ",e.title]}),u.jsxs("div",{className:"tg-info-row",children:[u.jsx("b",{children:"Participants"}),": ",(null==(s=null==e?void 0:e.participants)?void 0:s.length)||1]})]}):u.jsx(Oe,{chatId:null==e?void 0:e.id})]})]}):null},Ee=({pinned:e,onUnpin:t})=>e?u.jsxs("div",{style:{background:"rgba(42,127,255,0.1)",borderBottom:"1px solid #242428",padding:"8px 12px",display:"flex",justifyContent:"space-between",alignItems:"center"},children:[u.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center"},children:[u.jsx("span",{role:"img","aria-label":"pin",children:"ðŸ“Œ"}),u.jsx("div",{style:{fontSize:13,color:"#cfd3dc"},children:e.content})]}),u.jsx("button",{className:"tg-btn",onClick:t,children:"DÃ©sÃ©pingler"})]}):null,Ae=()=>{var e;const{logout:t,user:n}=p(),[s,i]=r.useState(null),[a,o]=r.useState(null),[c,h]=r.useState(null),[f,y]=r.useState(null),[x,j]=r.useState(!1);return b=null==n?void 0:n.uid,r.useEffect(()=>{if(!b)return;(e=>l(void 0,null,function*(){e&&(yield S(m(d,"presence",e),{online:!0,lastActive:D()},{merge:!0}))}))(b).catch(()=>{});const e=setInterval(()=>(e=>l(void 0,null,function*(){e&&(yield v(m(d,"presence",e),{lastActive:D()}))}))(b).catch(()=>{}),6e4),t=()=>Te(b).catch(()=>{});return window.addEventListener("beforeunload",t),()=>{clearInterval(e),window.removeEventListener("beforeunload",t),Te(b).catch(()=>{})}},[b]),r.useEffect(()=>{if(!s)return void o(null);const e=E(s,o);return()=>e&&e()},[s]),r.useEffect(()=>{var e;if(!a||"dm"!==a.type)return void h(null);const t=null==(e=a.participants)?void 0:e.find(e=>e!==(null==n?void 0:n.uid));if(!t)return void h(null);const s=O(t,h),i=(r=y,(l=t)?g(m(d,"presence",l),e=>{r(e.exists()?e.data():{online:!1})}):()=>{});var l,r;return()=>{s&&s(),i&&i()}},[a,n]),u.jsxs("div",{className:"tg-layout",children:[u.jsx(ee,{onOpenChat:i,activeChatId:s}),u.jsxs("div",{className:"tg-main",children:[u.jsx(Re,{chatMeta:a,peerUser:c,presenceText:a?"dm"===a.type?ae(null==f?void 0:f.online,null==f?void 0:f.lastActive):`${(null==(e=a.participants)?void 0:e.length)||1} participant(s)`:"",onLogout:t,onToggleInfo:()=>j(e=>!e)}),u.jsx(Ee,{pinned:null==a?void 0:a.pinned,onUnpin:()=>q(s)}),u.jsx("div",{style:{flex:1},children:s?u.jsx(Ie,{chatId:s,chatMeta:a}):u.jsx("div",{style:{padding:24},children:"Aucune conversation sÃ©lectionnÃ©e"})}),u.jsx(ke,{chatMeta:a,visible:x,onClose:()=>j(!1)})]})]});var b};export{Ae as default};
