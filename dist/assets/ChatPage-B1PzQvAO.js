import{r as s}from"./vendor-Be9Gvr8Z.js";import{u as e,j as a}from"./index-CxHrcTmC.js";import{a as i,u as t}from"./router-WS_FqKV8.js";import{A as n,m as l}from"./ui-CVUBDUKm.js";import"./query-BCFsIYE1.js";import"./virtual-BJqExeNh.js";import"./utils-CkSu2hCt.js";import"./error-BaU7SGNY.js";import"./toast-DAwFn72h.js";import"./state-CH3XQ_Yu.js";import"./firebase-DLJYeIMi.js";var c=(s,e,a)=>new Promise((i,t)=>{var n=s=>{try{c(a.next(s))}catch(e){t(e)}},l=s=>{try{c(a.throw(s))}catch(e){t(e)}},c=s=>s.done?i(s.value):Promise.resolve(s.value).then(n,l);c((a=a.apply(s,e)).next())});const o=()=>{var o;const{chatId:r}=i();t();const d=s.useRef(null),m=s.useRef(null),[u,p]=s.useState(""),[h,j]=s.useState(null),[x,v]=s.useState(null),[f,N]=s.useState(null),[y,b]=s.useState(!1),[g,w]=s.useState(!1),[k,C]=s.useState(!1),[E,S]=s.useState(!1),{user:R,chats:A,messages:L,activeChat:M,setActiveChat:T,addMessage:I,editMessage:P,deleteMessage:D,addReaction:F,markMessagesAsRead:V,loadChatMessages:z,contacts:U}=e(),q=A.find(s=>s.id===M),O=L[M]||[],B=null==(o=null==q?void 0:q.participants)?void 0:o.find(s=>s!==(null==R?void 0:R.uid)),K=U.find(s=>s.uid===B);s.useEffect(()=>{var s;null==(s=d.current)||s.scrollIntoView({behavior:"smooth"})},[O]),s.useEffect(()=>{M&&(z(M),V(M))},[M,z,V]);const Q=()=>{T(null)},$=s=>{if(s.senderId===(null==R?void 0:R.uid))switch(s.status){case"sent":return"‚úì";case"delivered":case"read":return"‚úì‚úì";default:return""}return""},_=["üëç","‚ù§Ô∏è","üòÇ","üòÆ","üò¢","üò°"];return q?a.jsxs("div",{className:"chat-page",children:[a.jsxs("div",{className:"chat-header",children:[a.jsx("button",{onClick:Q,className:"btn btn-icon btn-outline",children:a.jsx("i",{className:"fas fa-arrow-left"})}),a.jsxs("div",{className:"chat-participant",children:[a.jsx("div",{className:"participant-avatar",children:(null==K?void 0:K.photoURL)?a.jsx("img",{src:K.photoURL,alt:K.displayName}):a.jsx("i",{className:"fas fa-user"})}),a.jsxs("div",{className:"participant-info",children:[a.jsx("h2",{children:(null==K?void 0:K.displayName)||"Utilisateur"}),a.jsx("p",{className:"participant-status",children:k?"En train d'√©crire...":"En ligne"})]})]}),a.jsxs("div",{className:"chat-actions",children:[a.jsx("button",{className:"btn btn-icon action-btn",title:"Appel vocal",children:a.jsx("i",{className:"fas fa-phone"})}),a.jsx("button",{className:"btn btn-icon action-btn",title:"Appel vid√©o",children:a.jsx("i",{className:"fas fa-video"})}),a.jsx("button",{className:"btn btn-icon action-btn",title:"Plus d'options",children:a.jsx("i",{className:"fas fa-ellipsis-v"})})]})]}),a.jsx("div",{className:"chat-messages",children:a.jsxs("div",{className:"messages-container",children:[a.jsx(n,{children:O.length>0?O.map((s,e)=>{const i=s.senderId===(null==R?void 0:R.uid),t=(null==h?void 0:h.id)===s.id;return a.jsxs(l.div,{className:"message-item "+(i?"own":"other"),initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:-20},transition:{delay:.1*e},children:[s.replyTo&&a.jsxs("div",{className:"reply-to",children:[a.jsx("i",{className:"fas fa-reply"}),a.jsx("span",{children:"R√©ponse √† un message"})]}),a.jsxs("div",{className:"message-content",children:[t?a.jsxs("div",{className:"edit-message",children:[a.jsx("input",{type:"text",defaultValue:s.content,onKeyPress:e=>{var a,i;"Enter"===e.key&&(a=s.id,i=e.target.value,c(void 0,null,function*(){if(i.trim()&&q)try{window.showLoading&&window.showLoading("Modification du message..."),yield P(q.id,a,i.trim()),j(null),window.showToast&&window.showToast("Message modifi√© avec succ√®s","success")}catch(s){window.showError&&window.showError("Erreur lors de la modification du message")}}))},onBlur:()=>j(null),autoFocus:!0}),a.jsx("button",{onClick:()=>j(null),children:a.jsx("i",{className:"fas fa-times"})})]}):a.jsxs(a.Fragment,{children:[a.jsx("p",{children:s.content}),s.edited&&a.jsx("span",{className:"edited-indicator",children:"(modifi√©)"})]}),a.jsxs("div",{className:"message-meta",children:[a.jsx("span",{className:"message-time",children:(n=s.timestamp,new Date(n).toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"}))}),i&&a.jsx("span",{className:"message-status",children:$(s)})]}),s.reactions&&Object.keys(s.reactions).length>0&&a.jsx("div",{className:"message-reactions",children:Object.entries(s.reactions).map(([s,e])=>a.jsx("span",{className:"reaction",children:e},s))})]}),a.jsxs("div",{className:"message-actions",children:[a.jsx("button",{onClick:()=>N(f===s.id?null:s.id),className:"action-btn",title:"Ajouter une r√©action",children:a.jsx("i",{className:"fas fa-smile"})}),i&&a.jsxs(a.Fragment,{children:[a.jsx("button",{onClick:()=>j(s),className:"action-btn",title:"Modifier le message",children:a.jsx("i",{className:"fas fa-edit"})}),a.jsx("button",{onClick:()=>{return e=s.id,c(void 0,null,function*(){if(q&&window.confirm("Voulez-vous vraiment supprimer ce message ?"))try{window.showLoading&&window.showLoading("Suppression du message..."),yield D(q.id,e),window.showToast&&window.showToast("Message supprim√© avec succ√®s","success")}catch(s){window.showError&&window.showError("Erreur lors de la suppression du message")}});var e},className:"action-btn",title:"Supprimer le message",children:a.jsx("i",{className:"fas fa-trash"})})]})]}),f===s.id&&a.jsx(l.div,{className:"reactions-menu",initial:{opacity:0,scale:.8},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.8},children:_.map(e=>a.jsx("button",{onClick:()=>((s,e)=>c(void 0,null,function*(){q&&(yield F(q.id,s,{userId:R.uid,emoji:e}),N(null))}))(s.id,e),className:"reaction-btn",children:e},e))})]},s.id);var n}):a.jsxs(l.div,{className:"empty-messages",initial:{opacity:0},animate:{opacity:1},children:[a.jsx("i",{className:"fas fa-comments"}),a.jsx("h3",{children:"Aucun message"}),a.jsx("p",{children:"Commencez la conversation en envoyant un message !"})]})}),a.jsx("div",{ref:d})]})}),a.jsxs("form",{onSubmit:s=>c(void 0,null,function*(){if(s.preventDefault(),u.trim()&&q){const s={id:`msg_${Date.now()}`,content:u.trim(),senderId:R.uid,timestamp:Date.now(),type:"text",replyTo:(null==x?void 0:x.id)||null};try{window.showLoading&&window.showLoading("Envoi du message..."),yield I(q.id,s),p(""),v(null),b(!1)}catch(e){window.showError&&window.showError("Erreur lors de l'envoi du message")}}}),className:"chat-input-container",children:[x&&a.jsxs("div",{className:"reply-preview",children:[a.jsxs("div",{className:"reply-content",children:[a.jsx("i",{className:"fas fa-reply"}),a.jsxs("span",{children:["R√©ponse √† : ",x.content]})]}),a.jsx("button",{type:"button",onClick:()=>v(null),className:"btn btn-icon close-btn",title:"Annuler la r√©ponse",children:a.jsx("i",{className:"fas fa-times"})})]}),a.jsxs("div",{className:"message-input-wrapper",children:[a.jsxs("div",{className:"input-actions",children:[a.jsx("button",{type:"button",className:"btn btn-icon action-btn",onClick:()=>w(!g),title:"Pi√®ces jointes",children:a.jsx("i",{className:"fas fa-paperclip"})}),g&&a.jsxs(l.div,{className:"attachment-menu",initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,y:10},children:[a.jsxs("button",{type:"button",onClick:()=>{var s;return null==(s=m.current)?void 0:s.click()},className:"attachment-option",children:[a.jsx("i",{className:"fas fa-image"}),a.jsx("span",{children:"Photo"})]}),a.jsxs("button",{type:"button",onClick:()=>{var s;return null==(s=m.current)?void 0:s.click()},className:"attachment-option",children:[a.jsx("i",{className:"fas fa-video"}),a.jsx("span",{children:"Vid√©o"})]}),a.jsxs("button",{type:"button",onClick:()=>{var s;return null==(s=m.current)?void 0:s.click()},className:"attachment-option",children:[a.jsx("i",{className:"fas fa-file"}),a.jsx("span",{children:"Document"})]}),a.jsxs("button",{type:"button",onClick:()=>{var s;return null==(s=m.current)?void 0:s.click()},className:"attachment-option",children:[a.jsx("i",{className:"fas fa-microphone"}),a.jsx("span",{children:"Audio"})]})]}),a.jsx("button",{type:"button",className:"btn btn-icon action-btn",onClick:()=>b(!y),title:"Emojis",children:a.jsx("i",{className:"fas fa-smile"})})]}),a.jsxs("div",{className:"input-field-container",children:[a.jsx("input",{type:"text",value:u,onChange:s=>{p(s.target.value),C(!0),setTimeout(()=>C(!1),1e3)},placeholder:"Tapez votre message...",className:"message-input"}),a.jsx("button",{type:"submit",className:"btn btn-icon send-btn",disabled:!u.trim(),title:"Envoyer",children:a.jsx("i",{className:"fas fa-paper-plane"})})]})]}),y&&a.jsx(l.div,{className:"emoji-picker",initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,y:10},children:a.jsx("div",{className:"emoji-grid",children:["üòÄ","üòÉ","üòÑ","üòÅ","üòÜ","üòÖ","üòÇ","ü§£","üòä","üòá","üôÇ","üôÉ","üòâ","üòå","üòç","ü•∞","üòò","üòó","üòô","üòö","üòã","üòõ","üòù","üòú","ü§™","ü§®","üßê","ü§ì","üòé","ü§©","ü•≥","üòè","üòí","üòû","üòî","üòü","üòï","üôÅ","‚òπÔ∏è","üò£","üòñ","üò´","üò©","ü•∫","üò¢","üò≠","üò§","üò†","üò°","ü§¨","ü§Ø","üò≥","ü•µ","ü•∂","üò±","üò®","üò∞","üò•","üòì","ü§ó","ü§î","ü§≠","ü§´","ü§•","üò∂","üòê","üòë","üòØ","üò¶","üòß","üòÆ","üò≤","ü•±","üò¥","ü§§","üò™","üòµ","ü§ê","ü•¥","ü§¢","ü§Æ","ü§ß","üò∑","ü§í","ü§ï"].map((s,e)=>a.jsx("button",{type:"button",onClick:()=>(s=>{p(e=>e+s),b(!1)})(s),className:"emoji-btn",children:s},e))})}),E&&a.jsxs(l.div,{className:"typing-indicator",initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},children:[a.jsxs("span",{children:[(null==K?void 0:K.displayName)||"Quelqu'un"," est en train d'√©crire"]}),a.jsxs("div",{className:"typing-dots",children:[a.jsx("div",{className:"typing-dot"}),a.jsx("div",{className:"typing-dot"}),a.jsx("div",{className:"typing-dot"})]})]}),a.jsx("input",{ref:m,type:"file",onChange:s=>{s.target.files[0]&&w(!1)},style:{display:"none"},accept:"image/*,video/*,audio/*,.pdf,.doc,.docx,.txt"})]})]}):a.jsxs("div",{className:"chat-error",children:[a.jsx("h3",{children:"Chat non trouv√©"}),a.jsx("button",{onClick:Q,className:"btn btn-primary",children:"Retour aux contacts"})]})};export{o as default};
