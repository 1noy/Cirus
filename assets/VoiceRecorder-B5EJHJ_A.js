import{u as e,j as r,a as t}from"./index-Brw_O7UB.js";import{r as n}from"./react-core-Bb0gnVVB.js";import"./mui-eVobQS_6.js";import"./emotion-BB-a1p0A.js";import"./router-Db56Mi_u.js";const a=()=>{const e=n.useRef(!0),r=n.useRef(new Set);return n.useEffect(()=>(e.current=!0,()=>{e.current=!1,r.current.forEach(e=>{try{"function"==typeof e&&e()}catch(r){}}),r.current.clear()}),[]),{isMounted:()=>e.current,addCleanup:e=>{e&&"function"==typeof e&&r.current.add(e)},removeCleanup:e=>{e&&r.current.delete(e)}}};function o({onClose:o,onSend:s,disabled:i=!1}){const[l,c]=n.useState(!1),[d,u]=n.useState(0),[p,f]=n.useState(null),[g,b]=n.useState(null),[x,y]=n.useState(!1),[m,h]=n.useState(0),[v,k]=n.useState(!1),S=n.useRef(null),w=n.useRef(null),R=n.useRef(null),{showToast:E}=e();(()=>{const e=n.useRef(new Set),{isMounted:r}=a();n.useEffect(()=>()=>{e.current.forEach(e=>{window.clearTimeout(e),window.clearInterval(e)}),e.current.clear()},[])})();const{isMounted:C}=a();n.useEffect(()=>("undefined"!=typeof Worker&&(R.current=new Worker("/audio-worker.js"),R.current.onmessage=e=>{if(!C())return;const{type:r,data:t,error:n}=e.data;switch(r){case"AUDIO_COMPRESSED":f(t);const e=URL.createObjectURL(t);b(e),h(t.duration||0),k(!1),E({message:`Audio compressé: ${Math.round(t.compressedSize/t.originalSize*100)}% de réduction`,severity:"success"});break;case"AUDIO_ANALYZED":break;case"ERROR":E({message:`Erreur audio: ${n}`,severity:"error"}),k(!1)}}),()=>{g&&URL.revokeObjectURL(g),R.current&&R.current.terminate()}),[g,E,C]);const M=n.useCallback(()=>{return e=this,r=function*(){if(C())try{const e=yield navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0,sampleRate:44100,channelCount:1}});S.current=new MediaRecorder(e,{mimeType:"audio/webm;codecs=opus"});const r=[];S.current.ondataavailable=e=>{r.push(e.data)},S.current.onstop=()=>{if(!C())return;const t=new Blob(r,{type:"audio/webm"});if(R.current)k(!0),R.current.postMessage({type:"COMPRESS_AUDIO",data:t});else{f(t);const e=URL.createObjectURL(t);b(e);const r=new Audio(e);r.addEventListener("loadedmetadata",()=>{h(r.duration)})}e.getTracks().forEach(e=>e.stop())},S.current.start(),c(!0),u(0);let t=Date.now();const n=()=>{if(l&&C()){u(Math.floor((Date.now()-t)/1e3));const e=requestAnimationFrame(n);return()=>cancelAnimationFrame(e)}};requestAnimationFrame(n),E({message:"Enregistrement démarré...",severity:"info"})}catch(e){if(!C())return;E({message:"Erreur d'accès au microphone",severity:"error"})}},new Promise((t,n)=>{var a=e=>{try{s(r.next(e))}catch(t){n(t)}},o=e=>{try{s(r.throw(e))}catch(t){n(t)}},s=e=>e.done?t(e.value):Promise.resolve(e.value).then(a,o);s((r=r.apply(e,null)).next())});var e,r},[l,E,C]),D=n.useCallback(()=>{C()&&S.current&&l&&(S.current.stop(),c(!1),E({message:"Enregistrement terminé",severity:"success"}))},[l,E,C]),A=n.useCallback(()=>{w.current&&C()&&(w.current.play(),y(!0))},[C]),j=n.useCallback(()=>{w.current&&C()&&(w.current.pause(),y(!1))},[C]),L=n.useCallback(()=>{C()&&p&&s&&(s(p,m),f(null),b(null),h(0),u(0),o())},[p,m,s,o,C]),I=n.useCallback(()=>{C()&&(f(null),b(null),h(0),u(0),k(!1),o())},[o,C]),U=n.useCallback(e=>{const r=e%60;return`${Math.floor(e/60).toString().padStart(2,"0")}:${r.toString().padStart(2,"0")}`},[]);return r("div",{style:{display:"flex",flexDirection:"column",gap:"12px",padding:"16px",background:"rgba(28, 198, 255, 0.05)",borderRadius:"12px",border:"1px solid rgba(62, 242, 255, 0.2)",marginTop:"12px"},children:[l&&r("div",{style:{display:"flex",alignItems:"center",gap:"12px",padding:"12px",background:"rgba(255, 71, 87, 0.1)",borderRadius:"8px",border:"1px solid rgba(255, 71, 87, 0.3)"},children:[t("div",{style:{width:"12px",height:"12px",borderRadius:"50%",background:"#ff4757",animation:"pulse 1s infinite"}}),r("span",{style:{color:"#ff4757",fontWeight:"600"},children:["Enregistrement en cours... ",U(d)]}),t("button",{onClick:D,style:{padding:"8px 16px",background:"linear-gradient(90deg, #ff4757 0%, #ff3742 100%)",border:"none",borderRadius:"6px",color:"#fff",cursor:"pointer",fontSize:"14px",fontWeight:"600"},children:"Arrêter"})]}),p&&!l&&r("div",{style:{display:"flex",alignItems:"center",gap:"12px",padding:"12px",background:"rgba(28, 198, 255, 0.1)",borderRadius:"8px",border:"1px solid rgba(28, 198, 255, 0.3)"},children:[t("button",{onClick:x?j:A,style:{padding:"8px",background:"linear-gradient(90deg, #1cc6ff 0%, #009fff 100%)",border:"none",borderRadius:"50%",color:"#fff",cursor:"pointer",fontSize:"16px",width:"36px",height:"36px",display:"flex",alignItems:"center",justifyContent:"center"},children:x?"⏸️":"▶️"}),r("div",{style:{flex:1},children:[t("div",{style:{fontSize:"14px",fontWeight:"600",color:"#3ef2ff"},children:"Message vocal"}),r("div",{style:{fontSize:"12px",color:"#a0f0ff"},children:["Durée: ",U(Math.floor(m))]})]}),r("div",{style:{display:"flex",gap:"12px",marginTop:"20px"},children:[t("button",{type:"button",onClick:L,disabled:!p||v,"aria-label":"Envoyer le message vocal",role:"button",tabIndex:0,style:{flex:1,padding:"12px 24px",border:"none",borderRadius:"8px",background:p&&!v?"linear-gradient(135deg, #1cc6ff 0%, #009fff 100%)":"rgba(255, 255, 255, 0.1)",color:"#fff",fontSize:"16px",fontWeight:"600",cursor:p&&!v?"pointer":"not-allowed",transition:"all 0.2s ease",opacity:p&&!v?1:.5},onMouseEnter:e=>{p&&!v&&(e.target.style.transform="translateY(-1px)",e.target.style.boxShadow="0 4px 12px rgba(28, 198, 255, 0.3)")},onMouseLeave:e=>{e.target.style.transform="translateY(0)",e.target.style.boxShadow="none"},onKeyDown:e=>{"Enter"!==e.key&&" "!==e.key||!p||v||(e.preventDefault(),L())},children:v?"Traitement...":"Envoyer"}),t("button",{type:"button",onClick:I,"aria-label":"Annuler l'enregistrement",role:"button",tabIndex:0,style:{flex:1,padding:"12px 24px",border:"1px solid rgba(255, 255, 255, 0.2)",borderRadius:"8px",background:"rgba(255, 255, 255, 0.1)",color:"#fff",fontSize:"16px",fontWeight:"600",cursor:"pointer",transition:"all 0.2s ease"},onMouseEnter:e=>{e.target.style.background="rgba(255, 255, 255, 0.2)",e.target.style.transform="translateY(-1px)"},onMouseLeave:e=>{e.target.style.background="rgba(255, 255, 255, 0.1)",e.target.style.transform="translateY(0)"},onKeyDown:e=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),I())},children:"Annuler"})]})]}),!l&&!p&&t("button",{onClick:M,disabled:i,style:{padding:"12px 20px",background:"linear-gradient(90deg, #1cc6ff 0%, #009fff 100%)",border:"none",borderRadius:"8px",color:"#fff",cursor:i?"not-allowed":"pointer",fontSize:"16px",fontWeight:"600",display:"flex",alignItems:"center",gap:"8px",opacity:i?.6:1,transition:"all 0.3s ease"},onMouseEnter:e=>{i||(e.target.style.transform="translateY(-1px)",e.target.style.boxShadow="0 4px 12px rgba(28, 198, 255, 0.4)")},onMouseLeave:e=>{e.target.style.transform="translateY(0)",e.target.style.boxShadow="0 2px 8px rgba(28, 198, 255, 0.3)"},children:"🎤 Enregistrer un message vocal"}),g&&t("audio",{ref:w,src:g,onEnded:()=>y(!1),onPause:()=>y(!1),onPlay:()=>y(!0),style:{display:"none"}})]})}export{o as default};
